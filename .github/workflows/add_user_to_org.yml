name: Issue Checklist Workflow
on:
  issues:
    types: [opened, edited]

jobs:
  check_issue_checklist:
    runs-on: ubuntu-latest
    steps:
      - name: Validate user input
        id: validation
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;

            console.log(issue.body)

            // Validate compliance checks
            const checkboxRegex = /\[x\]/;
            const checkboxes = issue.body.match(checkboxRegex) || [];
            let checklistComplete = checkboxes.length === 3;
            console.log(`Number of checks: ${checkboxes.length}`);

            // Validate email
            const emailRegex = /[a-zA-Z0-9._-]+@(allianz.)/;
            const email = issue.body.match(emailRegex);
            const emailIsValid = email !== null;
            console.log(`Email is valid: ${emailIsValid}`);

            // Validation result
            const passed = emailIsValid && checklistComplete
            core.setOutput('passed', passed);

            // Add comment to issue if validation fails
            if (!passed) {
              let comment = 'Before proceeding:\n\n';
              if (!emailIsValid) {
                comment += 'Please use an email address from Allianz.\n';
              }
              if (!checklistComplete) {
                comment += 'Please make sure to check all checkboxes.';
              }
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

          
      - name: Run the workflow if checklist is complete
        if: steps.validation.outputs.passed == 'true'
        run: |
          # Add your desired commands here to be executed when the checklist is complete
          # For example, you can run a shell script or any other commands
          echo "Checklist is complete! Running additional steps..."
          # Add your additional commands here